#!/bin/bash
set -e

command -v age >/dev/null 2>&1 || { echo "age not found. Install with: brew install age"; exit 1; }
command -v expect >/dev/null 2>&1 || { echo "expect not found. Install with: brew install expect"; exit 1; }

REPO_DIR="$(cd "$(dirname "$0")/.." && pwd)"
AGE_KEY="$HOME/.config/chezmoi/key.txt"
KEY_AGE="$REPO_DIR/key.txt.age"
PASSWORD_FILE="$REPO_DIR/.password"
AUTO_GENERATE=false
PASSWORD_LENGTH=32
PASSWORD_DIR="$HOME/.local/share/chezmoi"

usage() {
  cat <<'EOF'
Usage: scripts/rotate-password [--auto] [--length N]

Options:
  --auto        Auto-generate a new passphrase (A-Za-z0-9) via openssl.
  --length N    Password length for --auto mode. Default: 32.
  --password-dir DIR
                Sync .password to DIR/.password (default: ~/.local/share/chezmoi).
EOF
}

generate_password() {
  local length="$1"
  local password=""
  while [ "${#password}" -lt "$length" ]; do
    password="$password$(openssl rand -base64 "$length" | tr -dc 'A-Za-z0-9')"
  done
  printf '%s' "$password" | head -c "$length"
}

while [ $# -gt 0 ]; do
  case "$1" in
    --auto)
      AUTO_GENERATE=true
      ;;
    --length)
      shift
      if [ -z "${1:-}" ]; then
        echo "Error: --length requires a value."
        exit 1
      fi
      PASSWORD_LENGTH="$1"
      ;;
    --password-dir)
      shift
      if [ -z "${1:-}" ]; then
        echo "Error: --password-dir requires a directory path."
        exit 1
      fi
      PASSWORD_DIR="$1"
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown argument: $1"
      usage
      exit 1
      ;;
  esac
  shift
done

if ! [[ "$PASSWORD_LENGTH" =~ ^[0-9]+$ ]] || [ "$PASSWORD_LENGTH" -le 0 ]; then
  echo "Error: --length must be a positive integer."
  exit 1
fi

if [ ! -f "$AGE_KEY" ]; then
  echo "Age key not found: $AGE_KEY"
  echo "Run 'chezmoi apply' first to decrypt the key."
  exit 1
fi

if [ "$AUTO_GENERATE" = true ]; then
  command -v openssl >/dev/null 2>&1 || { echo "openssl not found."; exit 1; }
  NEW_PASSWORD="$(generate_password "$PASSWORD_LENGTH")"
  echo "Auto-generated a new passphrase (A-Za-z0-9, length=${PASSWORD_LENGTH})."
else
  # 手动输入新密码
  echo -n "Enter new passphrase: "
  read -rs NEW_PASSWORD
  echo
  echo -n "Confirm new passphrase: "
  read -rs CONFIRM
  echo
  if [ "$NEW_PASSWORD" != "$CONFIRM" ]; then
    echo "Error: passphrases do not match."
    exit 1
  fi
fi

if [ -z "$NEW_PASSWORD" ]; then
  echo "Error: passphrase must not be empty."
  exit 1
fi

# 用新密码重新加密私钥（原子写入）
# 注意：只有 key.txt.age 是密码加密的。
# 其他 .age 文件（如 git-identity.toml.age）使用 age 公钥加密，不受密码轮换影响。
TMPFILE=$(mktemp "$REPO_DIR/key.txt.age.XXXXXX")
trap 'rm -f "$TMPFILE"' EXIT

AGE_PW="$NEW_PASSWORD" AGE_KEY="$AGE_KEY" AGE_OUT="$TMPFILE" \
expect -c '
  log_user 0
  spawn age -p -o $env(AGE_OUT) $env(AGE_KEY)
  expect "Enter passphrase:"
  send "$env(AGE_PW)\r"
  expect "Confirm passphrase:"
  send "$env(AGE_PW)\r"
  expect eof
  catch wait result
  exit [lindex $result 3]
'

mv "$TMPFILE" "$KEY_AGE"
trap - EXIT

# 更新 .password
echo -n "$NEW_PASSWORD" > "$PASSWORD_FILE"
chmod 600 "$PASSWORD_FILE"

PASSWORD_DEST="$PASSWORD_DIR/.password"
mkdir -p "$PASSWORD_DIR"

SRC_ABS="$(cd "$(dirname "$PASSWORD_FILE")" && pwd -P)/$(basename "$PASSWORD_FILE")"
DST_ABS="$(cd "$PASSWORD_DIR" && pwd -P)/.password"
if [ "$SRC_ABS" != "$DST_ABS" ]; then
  install -m 600 "$PASSWORD_FILE" "$PASSWORD_DEST"
  echo "Synced .password to: $PASSWORD_DEST"
fi

echo "Password rotated. key.txt.age re-encrypted with new passphrase."
echo "Remember to NOT commit .password (it is gitignored)."
