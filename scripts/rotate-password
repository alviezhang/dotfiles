#!/bin/bash
set -e

command -v rage >/dev/null 2>&1 || { echo "rage not found. Install with: brew install rage"; exit 1; }

REPO_DIR="$(cd "$(dirname "$0")/.." && pwd)"
AGE_KEY="$HOME/.config/chezmoi/key.txt"
KEY_AGE="$REPO_DIR/key.txt.age"
PASSWORD_FILE="$REPO_DIR/.password"

if [ ! -f "$AGE_KEY" ]; then
  echo "Age key not found: $AGE_KEY"
  echo "Run 'chezmoi apply' first to decrypt the key."
  exit 1
fi

# 读取新密码
if [ -n "$1" ]; then
  NEW_PASSWORD="$1"
elif [ -f "$PASSWORD_FILE" ]; then
  NEW_PASSWORD=$(cat "$PASSWORD_FILE")
else
  echo -n "Enter new passphrase: "
  read -rs NEW_PASSWORD
  echo
fi

# 用新密码重新加密私钥
RAGE_PASSPHRASE="$NEW_PASSWORD" rage -p -o "$KEY_AGE" "$AGE_KEY"

# 更新 .password
echo -n "$NEW_PASSWORD" > "$PASSWORD_FILE"

echo "Password rotated. key.txt.age re-encrypted with new passphrase."
echo "Remember to NOT commit .password (it is gitignored)."
