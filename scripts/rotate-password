#!/bin/bash
set -e

command -v rage >/dev/null 2>&1 || { echo "rage not found. Install with: brew install rage"; exit 1; }

REPO_DIR="$(cd "$(dirname "$0")/.." && pwd)"
AGE_KEY="$HOME/.config/chezmoi/key.txt"
KEY_AGE="$REPO_DIR/key.txt.age"
PASSWORD_FILE="$REPO_DIR/.password"

if [ ! -f "$AGE_KEY" ]; then
  echo "Age key not found: $AGE_KEY"
  echo "Run 'chezmoi apply' first to decrypt the key."
  exit 1
fi

# 读取新密码（从环境变量、.password 文件或交互输入）
if [ -n "$NEW_PASSWORD" ]; then
  : # 已通过环境变量设置
elif [ -f "$PASSWORD_FILE" ]; then
  NEW_PASSWORD=$(cat "$PASSWORD_FILE")
else
  echo -n "Enter new passphrase: "
  read -rs NEW_PASSWORD
  echo
  echo -n "Confirm new passphrase: "
  read -rs CONFIRM
  echo
  if [ "$NEW_PASSWORD" != "$CONFIRM" ]; then
    echo "Error: passphrases do not match."
    exit 1
  fi
fi

if [ -z "$NEW_PASSWORD" ]; then
  echo "Error: passphrase must not be empty."
  exit 1
fi

# 用新密码重新加密私钥（原子写入）
# 注意：只有 key.txt.age 是密码加密的。
# 其他 .age 文件（如 git-identity.toml.age）使用 age 公钥加密，不受密码轮换影响。
TMPFILE=$(mktemp "$REPO_DIR/key.txt.age.XXXXXX")
trap 'rm -f "$TMPFILE"' EXIT
RAGE_PASSPHRASE="$NEW_PASSWORD" rage -p -o "$TMPFILE" "$AGE_KEY"
mv "$TMPFILE" "$KEY_AGE"
trap - EXIT

# 更新 .password
echo -n "$NEW_PASSWORD" > "$PASSWORD_FILE"
chmod 600 "$PASSWORD_FILE"

echo "Password rotated. key.txt.age re-encrypted with new passphrase."
echo "Remember to NOT commit .password (it is gitignored)."
