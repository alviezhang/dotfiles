#!/bin/bash
# key.txt.age hash: {{ include "key.txt.age" | sha256sum }}
# Re-decrypt on every apply/update so accidental local key edits are self-healed.
set -e

KEY_FILE="${HOME}/.config/chezmoi/key.txt"
SOURCE_DIR="{{ .chezmoi.sourceDir }}"

mkdir -p "${HOME}/.config/chezmoi"

# 密码来源：环境变量 > source 目录 .password > ~/.config/chezmoi/password > 交互式输入
PASSWORD=""
if [ -n "$CHEZMOI_AGE_PASSWORD" ]; then
    PASSWORD="$CHEZMOI_AGE_PASSWORD"
elif [ -f "$SOURCE_DIR/.password" ]; then
    PASSWORD="$(sed 's/[[:space:]]*$//' "$SOURCE_DIR/.password")"
elif [ -f "$HOME/.config/chezmoi/password" ]; then
    PASSWORD="$(sed 's/[[:space:]]*$//' "$HOME/.config/chezmoi/password")"
fi

if [ -n "$PASSWORD" ] && command -v expect &>/dev/null; then
    # 非交互：用 expect 提供密码给 age（通过环境变量避免进程参数泄露）
    AGE_PW="$PASSWORD" AGE_KEY="$KEY_FILE" AGE_SRC="$SOURCE_DIR/key.txt.age" \
    expect -c '
        log_user 0
        spawn age -d -o $env(AGE_KEY) $env(AGE_SRC)
        expect "Enter passphrase:"
        send "$env(AGE_PW)\r"
        expect eof
        catch wait result
        exit [lindex $result 3]
    '
else
    # 交互式输入密码
    chezmoi age decrypt --output "$KEY_FILE" --passphrase "$SOURCE_DIR/key.txt.age"
fi

chmod 600 "$KEY_FILE"
